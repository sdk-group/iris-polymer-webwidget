<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="include-libs.html">

<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../re-captcha/re-captcha.html">

<link rel="import" href="../iris-polymer-date-picker/iris-date-picker.html">
<link rel="import" href="iris-stepper.html">
<link rel="import" href="iris-ticketview.html">
<link rel="import" href="iris-counter.html">

<dom-module id="iris-webwidget">
  <template>
    <style>
      :host {
        @apply(--layout-vertical);
        @apply(--shadow-elevation-2dp);
      }

      .webwidget-page {
        @apply(--layout-vertical);
        justify-content: space-between;
      }

      .webwidget-page {
        @apply(--layout-flex-auto);
      }

      .webwidget-page .webwidget-actions {
        padding: 10px;
        @apply(--layout-horizontal);
        @apply(--layout-end-justified);
        border-top: 1px solid #ccc;
        min-height: 40px;
      }

      .webwidget-body {
        padding: 0 10px;
      }

      iris-stepper {
        padding: 15px 0;
        border-bottom: 1px solid #ccc;
      }

      iron-pages {
        @apply(--layout-flex-auto);
        @apply(--layout-vertical);
      }

      .webwidget-body {
        @apply(--layout-vertical);
        @apply(--layout-flex-auto);
      }

      .webwidget-body .list {
        @apply(--layout-flex-auto);
        height: 0;
        overflow: auto;
      }

      #loader {
        @apply(--layout);
        @apply(--layout-flex-auto);
        @apply(--layout-center-center);
      }

      #loader paper-spinner {
        --paper-spinner-stroke-width: 9px;
        height: 75px;
        width: 75px;
      }

      iris-counter {
        width: 300px;
        padding-top: 10px;
        text-align: center;
        margin: 0 auto;
      }

      #calendar .webwidget-body {
        @apply(--layout-horizontal);
        @apply(--layout-center-center);
        @apply(--layout-wrap);
      }

      #calendar paper-icon-button {
        width: 50px;
        height: 50px;
      }

      #calendar-widget {
        text-align: center;
        text-transform: capitalize;
      }

      #slots {
        @apply(--layout-flex-auto);
        padding: 10px 0;
      }

      .timeslot {
        padding: 10px;
        height: 50px;
        cursor: pointer;
      }

      .timeslot-content {
        padding: 10px;
        @apply(--shadow-elevation-2dp);
        border: 2px solid white;
      }

      .timeslot.selected .timeslot-content {
        @apply(--shadow-elevation-6dp);
        border: 2px solid var(--paper-light-blue-600);
      }

      #captcha .webwidget-body,
      #info .webwidget-body {
        @apply(--layout-center-center);
      }
    </style>
    <iris-stepper id="stepper" hidden$="[[ticketInfoVisible]]" steps="[[steps]]" states="{{states}}" selected="{{selected}}"></iris-stepper>

    <div hidden$="[[!loading]]" id="loader">
      <paper-spinner active></paper-spinner>
    </div>

    <iron-pages hidden$="[[fieldsEditorHidden]]" selected="[[selected]]">
      <div class="webwidget-page" id="webterminals-list">

        <div class="webwidget-body">
          <paper-input label="Название офиса" value="{{ofilter}}"></paper-input>
          <paper-listbox class="list" selected="{{selectedOffice}}">
            <template id="visibleOffices" is="dom-repeat" items="[[filterOfficeList(webterminals,ofilter)]]">
              <paper-item>
                [[item.label]]
              </paper-item>
            </template>
          </paper-listbox>
        </div>

        <div class="webwidget-actions">
          <paper-button disabled$="[[canNextPage(selectedOffice)]]" on-tap="nextPage">Далее</paper-button>
        </div>
      </div>

      <div class="webwidget-page" id="service-groups-list">
        <div class="webwidget-body">
          <iron-pages selected="[[selectedServiceField]]">
            <div class="webwidget-page" id="service-count">
              <paper-input label="Название услуги" value="{{sgfilter}}"></paper-input>

              <paper-listbox class="list" selected="{{selectedService}}">
                <template id="visibleServices" is="dom-repeat" items="[[filterServiceList(services,sgfilter)]]">
                  <paper-item>
                    [[item.label]]
                  </paper-item>
                </template>
              </paper-listbox>

              <div class="webwidget-actions">
                <paper-button on-tap="previousPage">Назад</paper-button>
                <paper-button disabled$="[[canNextPage(selectedService)]]" on-tap="nextServiceField">Далее</paper-button>
              </div>
            </div>

            <div class="webwidget-page" id="service-count">
              <div class="webwidget-body">
                <iris-counter count="{{serviceCount}}" min="1"></iris-counter>
              </div>

              <div class="webwidget-actions">
                <paper-button on-tap="previousServiceField">Назад</paper-button>
                <paper-button on-tap="nextPage">Далее</paper-button>
              </div>
            </div>
          </iron-pages>
        </div>
      </div>

      <div class="webwidget-page" id="date-and-time">
        <iron-pages selected="[[selectedDateField]]">
          <div class="webwidget-page" id="calendar">
            <div class="webwidget-body">
              <paper-icon-button disabled$="[[canPrevMonth(monthFromNow)]]" on-tap="prevMonth" icon="chevron-left"></paper-icon-button>
              <div id="calendar-widget">
                [[monthName(monthFromNow)]]
                <iris-date-picker id="picker" hide-month-picker date="{{pickerDate}}" available-days="{{availableDays}}" selected="{{dedicatedDate}}"></iris-date-picker>
              </div>
              <paper-icon-button disabled$="[[canNextMonth(monthFromNow,isLastAvailable)]]" on-tap="nextMonth" icon="chevron-right"></paper-icon-button>
            </div>
            <div class="webwidget-actions">
              <paper-button on-tap="previousPage">Назад</paper-button>
              <paper-button disabled$="[[canNextField(dedicatedDate)]]" on-tap="nextDateField">Далее</paper-button>
            </div>
          </div>

          <div class="webwidget-page" id="slot-picker">
            <div class="webwidget-body">
              <iron-list id="slots" items="[[slots]]" as="item" grid selected-items="{{selectedSlot}}" selection-enabled>
                <template>
                  <span class$="[[_computedClass(selected)]]">
                    <span class="timeslot-content">    [[slotText(item.time_description)]]                </span>
                  </span>
                </template>
              </iron-list>
            </div>
            <div class="webwidget-actions">
              <paper-button on-tap="previousDateField">Назад</paper-button>
              <paper-button disabled$="[[canNextField(selectedSlot)]]" on-tap="nextPage">Далее</paper-button>
            </div>
          </div>
        </iron-pages>
      </div>

      <div class="webwidget-page" id="client-fields">
        <iron-pages selected="[[selectedField]]">
          <div class="webwidget-page" id="fio-fields">
            <div class="webwidget-body">
              <paper-input label="Фамилия" value="{{clientSurname}}"></paper-input>
              <paper-input label="Имя" value="{{clientName}}"></paper-input>
              <paper-input label="Отчество" vakue="{{clientPatronymic}}"></paper-input>
            </div>

            <div class="webwidget-actions">
              <paper-button on-tap="previousField">Назад</paper-button>
              <paper-button disabled$="[[canNextField(clientSurname)]]" on-tap="nextField">Далее</paper-button>
            </div>
          </div>

          <div class="webwidget-page" id="captcha">
            <div class="webwidget-body">
              <re-captcha id="captcha-widget" sitekey="6LceSiITAAAAAMroOv8D8KjDqlpfwCjQBtLj9xQA" response="{{captchaResponse}}"></re-captcha>
            </div>
            <div class="webwidget-actions">
              <paper-button on-tap="previousPage">Назад</paper-button>
              <!-- disabled$="[[canNextPage(captchaResponse)]]" -->
              <paper-button on-tap="nextPage">Завершить</paper-button>
            </div>
          </div>
        </iron-pages>
      </div>

    </iron-pages>

    <div hidden$="[[!ticketInfoVisible]]" class="webwidget-page" id="info">
      <div class="webwidget-body">
        <iris-ticketview ticket="[[ticket]]"></iris-ticketview>
      </div>
      <div class="webwidget-actions">
        <paper-button raised on-tap="final">Ок</paper-button>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'iris-webwidget',
      properties: {
        name: {
          type: Boolean
        },
        fieldsEditorHidden: {
          type: Boolean,
          computed: '_computeFieldsEditorVisibility(loading,ticketInfoVisible)'
        }
      },
      _computeFieldsEditorVisibility(loading, ticketInfoVisible) {
        return loading || ticketInfoVisible;
      },

      ready() {
        IRIS.webwidget.getTerminals().then(d => {
          this.webterminals = _.values(d);
          this.loading = false;
        });

        this.reset();
        this.steps = ['Офис', 'Услуга', 'Дата и время', 'Дополнительные поля'];
        this.states = Array(this.steps.length);
        this.actions = [false, 'getLayouts', 'getAvailableDays', false, 'storeAndConfirm'];
        this.field_actions = [false, false];
        this.loading = true;
      },
      reset() {
        this.clientSurname = null;
        this.dedicatedDate = null;
        this.selectedOffice = null;
        this.captchaResponse = null;
        this.selectedService = null;
        this.monthFromNow = 0;
        this.pirckerDate = moment().format();
        this.serviceCount = 1;
        this.selected = 0;
        this.selectedField = 0;
        this.selectedServiceField = 0;
        this.selectedDateField = 0;
        this.ticketInfoVisible = false;
        this.$["captcha-widget"].isWidgetLoaded() && this.$["captcha-widget"].reset();
        this.$.picker.selections = [];
      },
      fieldsHidden(loading, ticketInfoVisible) {
        console.log('FH', loading, ticketInfoVisible);
        return loading || ticketInfoVisible;
      },
      filterOfficeList(webterminals, ofilter) {
        this.selectedOffice = null;
        return this.filterList(webterminals, ofilter);
      },
      filterServiceList(webterminals, ofilter) {
        this.selectedService = null;
        return this.filterList(webterminals, ofilter);
      },
      filterList(webterminals, ofilter) {
        if (!ofilter) return webterminals;
        let result = [];
        webterminals.forEach(t => ~t.label.indexOf(ofilter) && result.push(t))
        return result;
      },
      doAction(actionset, step) {
        let action = actionset[step];
        console.log(action);
        if (!action) return false;

        this.loading = true;
        return this[action]().then(d => this.loading = false);
      },
      nextPage() {
        this.selected++;
        this.doAction(this.actions, this.selected);
      },
      nextServiceField() {
        this.selectedServiceField++;
      },
      previousServiceField() {
        this.selectedServiceField--;
      },
      nextDateField() {
        this.selectedDateField++;
        this.doAction(['getSlots'], 0);
      },
      previousDateField() {
        this.selectedDateField--;
      },
      getLayouts() {
        let items = this.$.visibleOffices.items;
        this.terminal_id = items[this.selectedOffice].id;

        return IRIS.webwidget.getTerminalLayout(this.terminal_id).then(d => this.services = d.base.root.content);
      },
      previousPage() {
        this.selected--;
      },
      nextField() {
        this.selectedField++;
        this.doAction(this.field_actions, this.selectedField);
      },
      monthInfo(month_offset) {
        let now = moment();
        now.add(month_offset, 'months');

        let month = now.format('M');
        let year = now.format('GGGG');
        let day = now.format('D');
        let days_in_month = new Date(year, month, 0).getDate();

        return {
          now,
          days_in_month,
          day,
          year,
          month
        };
      },
      getAvailableDays() {
        this.$.picker.selections = [];

        let items = this.$.visibleServices.items;
        this.ticketQuery = this.ticketQuery || {};
        this.ticketQuery.service = items[this.selectedService].id;
        this.ticketQuery.service_count = this.serviceCount;
        this.ticketQuery.workstation = this.terminal_id;

        let info = this.monthInfo(this.monthFromNow);
        this.pickerDate = info.now;
        this.ticketQuery.start = this.monthFromNow === 0 ? 0 : this.ticketQuery.end + 1;
        this.ticketQuery.end = this.monthFromNow === 0 ? info.days_in_month - info.day : info.days_in_month + this.ticketQuery.end + 1;

        return IRIS.webwidget.getAvailableDays(this.ticketQuery).then(data => this.processAvailableDays(data));
      },
      processAvailableDays(data) {
        this.isLastAvailable = !data.done;
        this.availableDays = _.reduce(data.days, (acc, day) => {
          if (day.is_available) acc.push(day.date.slice(0, 10));
          return acc;
        }, []);
        this.dedicatedDate = null;
      },
      getSlots() {
        this.ticketQuery.dedicated_date = this.dedicatedDate;
        return IRIS.webwidget.getDaySlots(this.ticketQuery).then((d) => {
          this.slots = d.slots;
          document.querySelector('iron-list').fire('iron-resize');
        });
      },
      storeAndConfirm() {
        this.ticketQuery.time_description = this.selectedSlot.time_description;
        this.ticketQuery.client = {
          name: this.clientSurname + " " + this.clientName + " " + this.clientPatronymic
        };
        this.ticketQuery.captcha_response = this.captchaResponse;

        console.log(this.ticketQuery);
        return IRIS.webwidget.confirmTicket(this.ticketQuery).then(d => {
          this.ticket = d.ticket;
          this.ticketInfoVisible = true;
        });
      },
      slotText(desc) {
        let ts = _.map(desc, t => _.padStart(((t / 3600) | 0), 2, '0') + ':' + _.padStart((t % 3600) / 60, 2, '0'))
        return ts.join(' - ');
      },
      previousField() {
        this.selectedField--;
      },
      canNextPage(value) {
        return _.isUndefined(value) || value === null;
      },
      canPrevPage(value) {

      },
      canNextField(value) {
        return _.isUndefined(value) || value === null || value === '';
      },
      canPrevMonth(x) {
        return x <= 0;
      },
      canNextMonth() {
        return !this.isLastAvailable;
      },
      prevMonth() {
        this.makeDate(-1);
      },
      nextMonth() {
        this.makeDate(1);
      },
      makeDate(v) {
        this.dedicatedDate = null;
        this.monthFromNow = this.monthFromNow + v;
        this.pirckerDate = moment().add(this.monthFromNow, 'month');
        this.doAction(['getAvailableDays'], 0);
      },
      monthName() {
        return moment().add(this.monthFromNow, 'month').format('MMMM')
      },
      _computedClass(isSelected) {
        var classes = 'timeslot';
        if (isSelected) {
          classes += ' selected';
        }
        return classes;
      },
      final() {
        this.reset();
        console.log('FINAL');
      }
    });
  </script>
</dom-module>
