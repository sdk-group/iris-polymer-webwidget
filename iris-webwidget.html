<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="include-libs.html">

<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">

<link rel="import" href="../re-captcha/re-captcha.html">

<link rel="import" href="../iris-polymer-date-picker/iris-date-picker.html">
<link rel="import" href="iris-stepper.html">
<link rel="import" href="iris-counter.html">

<dom-module id="iris-webwidget">
  <template>
    <style>
      :host {
        display: block;
      }
      
      .webwidget-page paper-button {
        float: right;
      }
    </style>

    <iris-stepper id="stepper" steps="[[steps]]" states="{{states}}" selected="{{selected}}"></iris-stepper>

    <div hidden$="{{!loading}}" id="loader">
      <paper-spinner active></paper-spinner>
    </div>

    <iron-pages hidden$="{{loading}}" selected="[[selected]]">
      <div class="webwidget-page" id="webterminals-list">
        <paper-input label="Название офиса" value="{{ofilter}}"></paper-input>
        <paper-listbox selected="{{selectedOffice}}">
          <template id="visibleOffices" is="dom-repeat" items="[[filterOfficeList(webterminals,ofilter)]]">
            <paper-item>
              [[item.label]]
            </paper-item>
          </template>
        </paper-listbox>

        <paper-button disabled$="[[canNextPage(selectedOffice)]]" on-tap="nextPage" raised>Далее</paper-button>
      </div>

      <div class="webwidget-page" id="service-groups-list">
        <paper-input label="Название услуги" value="{{sgfilter}}"></paper-input>

        <paper-listbox selected="{{selectedService}}">
          <template id="visibleServices" is="dom-repeat" items="[[filterServiceList(services,sgfilter)]]">
            <paper-item>
              [[item.label]]
            </paper-item>
          </template>
        </paper-listbox>

        <paper-button disabled$="[[canNextPage(selectedService)]]" on-tap="nextPage" raised>Далее</paper-button>
        <paper-button disabled$="[[canPrevPage(selectedService)]]" on-tap="previousPage" raised>Назад</paper-button>
      </div>

      <div class="webwidget-page" id="client-fields">
        <iron-pages selected="[[selectedField]]">
          <div id="service-count">
            <iris-counter count="{{serviceCount}}"></iris-counter>

            <paper-button disabled$="[[canNextField(serviceCount)]]" on-tap="nextField" raised>Далее</paper-button>
            <paper-button disabled$="[[canPrevField(serviceCount)]]" on-tap="previousPage" raised>Назад</paper-button>
          </div>

          <div id="calendar">
            <iris-date-picker></iris-date-picker>
            <paper-button disabled$="[[canNextField(serviceCount)]]" on-tap="nextField" raised>Далее</paper-button>
            <paper-button disabled$="[[canPrevField(serviceCount)]]" on-tap="previousField" raised>Назад</paper-button>
          </div>

          <div id="slot-picker">
            <iron-list items="[[slots]]" as="item">
              <template>
                <div>
                  [[item.label]]
                </div>
              </template>
            </iron-list>
            <paper-button disabled$="[[canNextField(serviceCount)]]" on-tap="nextField" raised>Далее</paper-button>
            <paper-button disabled$="[[canPrevField(serviceCount)]]" on-tap="previousField" raised>Назад</paper-button>
          </div>

          <div id="fio-fields">
            <paper-input label="Фамилия" value="{{clientSurname}}"></paper-input>
            <paper-input label="Имя" value="{{clientName}}"></paper-input>
            <paper-input label="Отчество" vakue="{{clientPatronymic}}"></paper-input>

            <paper-button disabled$="[[canNextField(serviceCount)]]" on-tap="nextPage" raised>Далее</paper-button>
            <paper-button disabled$="[[canPrevField(serviceCount)]]" on-tap="previousField" raised>Назад</paper-button>
          </div>
        </iron-pages>

      </div>

      <div class="webwidget-page" id="captcha">
        <re-captcha sitekey="6LceSiITAAAAAMroOv8D8KjDqlpfwCjQBtLj9xQA" response="{{captchaResponse}}"></re-captcha>
        <paper-button disabled$="[[canNextPage(captchaResponse)]]" on-tap="nextPage" raised>Далее</paper-button>
        <paper-button disabled$="[[canPrevPage(captchaResponse)]]" on-tap="previousPage" raised>Назад</paper-button>
      </div>

      <div class="webwidget-page" id="info">
        <paper-button raised on-tap="final">Ок</paper-button>
      </div>
    </iron-pages>

  </template>
  <script>
    Polymer({
      is: 'iris-webwidget',
      properties: {
        name: {
          type: Boolean
        }
      },
      ready() {
        IRIS.webwidget.getTerminals().then(d => {
          this.webterminals = d;
          this.loading = false;
        });

        this.slots = [{
          label: "10:00 - 11:00"
        }, {
          label: "11:00 - 12:00"
        }, {
          label: "12:00 - 13:00"
        }, {
          label: "13:00 - 14:00"
        }];

        this.serviceCount = 0;
        this.max = 10;
        this.selected = 0;
        this.selectedField = 0;
        this.loading = true;
        this.steps = ['Офис', 'Услуга', 'Поля юзера', 'Капча', 'Инфо'];
        this.states = Array(this.steps.length);
        this.actions = [false, 'getLayouts', 'getServices'];
        this.field_actions = [false, 'getAvailableDays', 'getServices'];

      },
      filterOfficeList(webterminals, ofilter) {
        this.selectedOffice = null;
        return this.filterList(webterminals, ofilter);
      },
      filterServiceList(webterminals, ofilter) {
        this.selectedService = null;
        return this.filterList(webterminals, ofilter);
      },
      filterList(webterminals, ofilter) {
        if (!ofilter) return webterminals;
        let result = [];
        webterminals.forEach(t => ~t.label.indexOf(ofilter) && result.push(t))
        return result;
      },
      doAction(actionset, step) {
        let action = actionset[step];
        console.log(actionset, step, action);
        if (!action) return false;

        this.loading = true;
        return this[action]().then(d => this.loading = false);
      },
      nextPage() {
        this.selected++;
        this.doAction(this.actions, this.selected);
      },
      getLayouts() {
        let items = this.$.visibleOffices.items;
        this.terminal_id = items[this.selectedOffice];
        return IRIS.webwidget.getTerminalLayout(this.terminal_id).then(d => this.services = d.base.root.content);
      },
      getServices() {
        let items = this.$.visibleServices.items;
        this.ticketQuery = {
          'service': items[this.selectedService].id
        };
        return Promise.resolve(true);
      },
      previousPage() {
        this.selected--;
      },
      nextField() {
        this.selectedField++;
        this.doAction(this.field_actions, this.selectedField);
      },
      getAvailableDays() {
        this.ticketQuery.service_count = this.serviceCount;
        return IRIS.webwidget.getAvailableDays(this.ticketQuery);
      },
      previousField() {
        this.selectedField--;
      },
      canNextPage(value) {

      },
      canPrevPage(value) {

      },
      canNextField(value) {

      },
      canPrevField(value) {

      },
      final() {
        console.log('FINAL');
      }
    });
  </script>
</dom-module>
e>